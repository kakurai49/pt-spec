<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14">
  <title>BEATæ¥½å™¨ â€” å‹•ãä»•æ§˜æ›¸ï¼ˆResponsive / WebAudioï¼‰</title>

  <style>
    :root{
      --bg:#0b0f14; --panel:#121a24; --panel2:#0f1620;
      --txt:#e6edf3; --muted:#9fb0c0; --accent:#7ee787; --warn:#ff7b72;
      --line:#223042;
      --radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --stepSize: 34px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% 0%, #112033 0%, var(--bg) 55%);
      color: var(--txt);
    }
    a{ color: var(--accent); }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 14px 44px;
    }
    header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      margin: 10px 0 14px;
    }
    .title{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size: 20px; letter-spacing:.3px; }
    .subtitle{ color: var(--muted); font-size: 13px; line-height: 1.4; }

    .badge{
      background: linear-gradient(180deg, rgba(126,231,135,.18), rgba(126,231,135,.08));
      border: 1px solid rgba(126,231,135,.25);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      min-width: 260px;
    }
    .badge .row{ display:flex; justify-content:space-between; gap:10px; }
    .badge .k{ color:var(--muted); font-size:12px; }
    .badge .v{ font-weight:600; font-size:12px; }

    main{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(18,26,36,.92), rgba(15,22,32,.92));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      flex-wrap: wrap;
    }
    .card .hd h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .card .bd{ padding: 12px; }
    .muted{ color: var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono", "Liberation Mono", monospace; }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .ctrl{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 10px;
    }
    .ctrl label{
      display:flex; justify-content:space-between; gap:10px;
      font-size: 12px; color: var(--muted);
      margin-bottom: 8px;
    }
    input[type="range"]{ width:100%; }

    .btns{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    button{
      border:1px solid rgba(255,255,255,.1);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      touch-action: manipulation;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button.primary{
      background: linear-gradient(180deg, rgba(126,231,135,.25), rgba(126,231,135,.12));
      border-color: rgba(126,231,135,.3);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(255,123,114,.22), rgba(255,123,114,.10));
      border-color: rgba(255,123,114,.25);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .gridWrap{ display:flex; flex-direction:column; gap:10px; }
    .trackRow{
      display:grid;
      grid-template-columns: 70px 1fr;
      gap: 10px;
      align-items:center;
    }
    .trackLabel{
      font-size: 12px;
      color: var(--muted);
      display:flex; flex-direction:column; gap:2px;
    }
    .trackLabel strong{ color: var(--txt); font-size: 13px; }

    .steps{
      display:grid;
      grid-template-columns: repeat(16, var(--stepSize));
      gap: 6px;
      align-items:center;
      justify-content:flex-start;
      overflow-x:auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }
    .step{
      width: var(--stepSize);
      height: var(--stepSize);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      user-select:none;
      cursor:pointer;
      position:relative;
      touch-action: manipulation;
    }
    .step.on{
      background: linear-gradient(180deg, rgba(126,231,135,.35), rgba(126,231,135,.15));
      border-color: rgba(126,231,135,.35);
    }
    .step.playhead::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 14px;
      border: 2px solid rgba(126,231,135,.55);
      pointer-events:none;
      box-shadow: 0 0 0 4px rgba(126,231,135,.08);
    }

    .spec{
      display:flex;
      flex-direction:column;
      gap: 10px;
      font-size: 13px;
      line-height: 1.55;
    }
    .chip{
      display:inline-flex;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.06);
      padding: 6px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    pre{
      margin:0;
      padding: 10px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      overflow:auto;
      font-size: 12px;
      color: #dbe7f2;
    }

    .status{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      padding: 10px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(255,255,255,.25);
    }
    .dot.ok{ background: rgba(126,231,135,.85); }
    .dot.bad{ background: rgba(255,123,114,.85); }

    /* responsive */
    @media (max-width: 900px){
      main{ grid-template-columns: 1fr; }
      header{ flex-direction:column; }
      .badge{ width:100%; min-width: unset; }
      .trackRow{ grid-template-columns: 60px 1fr; }
      :root{ --stepSize: 38px; }
    }
    @media (max-width: 520px){
      /* ã‚¹ãƒãƒ›ã¯æ“ä½œã‚’å¤§ãã */
      :root{ --stepSize: 40px; }
      .controls{ grid-template-columns: 1fr; }
      .btns{ width:100%; }
      button{ width:100%; padding: 12px 14px; }
      .card .hd{ align-items:stretch; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>BEATæ¥½å™¨ â€” å‹•ãä»•æ§˜æ›¸</h1>
        <div class="subtitle">
          ã‚¹ãƒãƒ›å¯¾å¿œï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼‰ï¼Web Audio APIã€‚<br/>
          è¿½åŠ ï¼š<span class="mono">ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£° ON/OFF</span>ï¼ˆWebAudioã®ç”Ÿæˆ/åœæ­¢ï¼‰ã‚’æ­è¼‰ã€‚
        </div>
      </div>

      <div class="badge" aria-label="runtime status">
        <div class="row"><div class="k">Audio</div><div class="v mono" id="audioState">off</div></div>
        <div class="row"><div class="k">BPM</div><div class="v mono" id="bpmView">120</div></div>
        <div class="row"><div class="k">Step</div><div class="v mono" id="stepView">-</div></div>
      </div>
    </header>

    <main>
      <!-- left -->
      <section class="card">
        <div class="hd">
          <h2>â‘  æ¥½å™¨ï¼ˆç·¨é›†ãƒ»å†ç”Ÿï¼‰</h2>
          <div class="btns">
            <button class="primary" id="audioToggleBtn" aria-pressed="false">ğŸ”‡ ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°: OFF</button>
            <button class="primary" id="playBtn" disabled>â–¶ Play</button>
            <button class="danger" id="stopBtn" disabled>â–  Stop</button>
            <button id="clearBtn">Clear</button>
            <button id="demoBtn">Load Demo</button>
          </div>
        </div>

        <div class="bd">
          <div class="controls">
            <div class="ctrl">
              <label><span>BPM</span><span class="mono" id="bpmLabel">120</span></label>
              <input id="bpm" type="range" min="60" max="180" value="120" />
              <div class="muted" style="margin-top:6px;font-size:12px;">16åˆ†éŸ³ç¬¦ï¼ˆ16ã‚¹ãƒ†ãƒƒãƒ—ï¼‰ã¨ã—ã¦å†ç”Ÿ</div>
            </div>
            <div class="ctrl">
              <label><span>Master</span><span class="mono" id="gainLabel">0.80</span></label>
              <input id="gain" type="range" min="0" max="1" step="0.01" value="0.80" />
              <div class="muted" style="margin-top:6px;font-size:12px;">ã‚¹ãƒãƒ›ã¯éŸ³é‡ã‚’å°ã•ã‚ã‹ã‚‰æ¨å¥¨</div>
            </div>
          </div>

          <div style="height:10px;"></div>

          <div class="gridWrap" aria-label="step sequencer">
            <div class="trackRow">
              <div class="trackLabel"><strong>K</strong><span class="muted">Kick</span></div>
              <div class="steps" id="stepsK"></div>
            </div>
            <div class="trackRow">
              <div class="trackLabel"><strong>S</strong><span class="muted">Snare</span></div>
              <div class="steps" id="stepsS"></div>
            </div>
            <div class="trackRow">
              <div class="trackLabel"><strong>H</strong><span class="muted">Hat</span></div>
              <div class="steps" id="stepsH"></div>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="status">
            <span class="dot" id="dot"></span>
            <span class="muted" id="statusText">ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°ã‚’ONã«ã—ã¦ã‹ã‚‰ Play ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚</span>
          </div>
        </div>
      </section>

      <!-- right -->
      <aside class="card">
        <div class="hd">
          <h2>â‘¡ ä»•æ§˜ï¼ˆå‹ã‚’é¸ã¶å·¥å­¦ï¼‰</h2>
          <div class="muted mono" style="font-size:12px;">v1.1</div>
        </div>
        <div class="bd spec">
          <div>
            <span class="chip">InputType</span>
            <span class="chip">ModelType</span>
            <span class="chip">ProcessType</span>
            <span class="chip">OutputType</span>
          </div>

          <div>
            <div class="muted" style="margin-bottom:6px;">ç¾åœ¨ã®å…¥åŠ›ï¼ˆUIï¼‰â†’ å†…éƒ¨ãƒ¢ãƒ‡ãƒ«ï¼ˆJSONï¼‰</div>
            <pre id="modelDump">{}</pre>
          </div>

          <div>
            <div class="muted" style="margin-bottom:6px;">å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆä»•æ§˜ï¼‰</div>
            <pre class="mono">
Input(UI)
  â”œâ”€ bpm: number
  â””â”€ tracks: {K,S,H} each 16 steps boolean
Model(Song)
  â”œâ”€ bpm: number
  â””â”€ tracks: Record&lt;Instrument, boolean[16]&gt;
Process
  â”œâ”€ schedule: stepâ†’time (16th note)
  â”œâ”€ synth: Hitâ†’sound (osc + envelope / noise)
  â””â”€ mix: sum + limiter
Output
  â”œâ”€ audio: WebAudio playback
  â””â”€ report: ASCII + JSON dump
            </pre>
          </div>

          <div>
            <div class="muted" style="margin-bottom:6px;">ASCIIè¡¨ç¤ºï¼ˆå‡ºåŠ›ã®ä¸€ç¨®ï¼‰</div>
            <pre id="asciiDump">K: ----------------
S: ----------------
H: ----------------</pre>
          </div>

          <div class="muted" style="font-size:12px;">
            ãƒ¡ãƒ¢ï¼šã“ã®ãƒšãƒ¼ã‚¸ã¯ã€Œå‹•ãä»•æ§˜æ›¸ã€ã§ã™ã€‚UIã‚’å¤‰ãˆã‚‹ï¼å…¥åŠ›å‹ãŒå¤‰ã‚ã‚‹ â†’ ãƒ¢ãƒ‡ãƒ«/å‡¦ç†/å‡ºåŠ›ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // -----------------------------
    // Model
    // -----------------------------
    const N_STEPS = 16;
    const instruments = ["K","S","H"];

    const model = {
      bpm: 120,
      master: 0.80,
      tracks: {
        K: Array(N_STEPS).fill(false),
        S: Array(N_STEPS).fill(false),
        H: Array(N_STEPS).fill(false),
      }
    };

    const demo = {
      bpm: 120,
      master: 0.80,
      tracks: {
        K: "x---x---x---x---",
        S: "----x-------x---",
        H: "x-x-x-x-x-x-x-x-",
      }
    };

    function parsePattern(s){
      const out = Array(N_STEPS).fill(false);
      for(let i=0;i<N_STEPS;i++){
        const ch = (s[i] || "-");
        out[i] = (ch.toLowerCase() === "x");
      }
      return out;
    }

    function toPattern(arr){
      return arr.map(v => v ? "x" : "-").join("");
    }

    // -----------------------------
    // View helpers
    // -----------------------------
    const el = (id) => document.getElementById(id);

    const bpmRange = el("bpm");
    const bpmLabel = el("bpmLabel");
    const bpmView  = el("bpmView");
    const gainRange = el("gain");
    const gainLabel = el("gainLabel");

    const audioToggleBtn = el("audioToggleBtn");
    const playBtn = el("playBtn");
    const stopBtn = el("stopBtn");
    const clearBtn = el("clearBtn");
    const demoBtn = el("demoBtn");

    const modelDump = el("modelDump");
    const asciiDump = el("asciiDump");
    const stepView = el("stepView");
    const audioState = el("audioState");
    const dot = el("dot");
    const statusText = el("statusText");

    const stepsEl = {
      K: el("stepsK"),
      S: el("stepsS"),
      H: el("stepsH"),
    };

    function renderGrid(){
      for(const inst of instruments){
        stepsEl[inst].innerHTML = "";
        for(let i=0;i<N_STEPS;i++){
          const d = document.createElement("div");
          d.className = "step" + (model.tracks[inst][i] ? " on" : "");
          d.textContent = (i % 4 === 0) ? "|" : "â€¢";
          d.setAttribute("role","button");
          d.setAttribute("aria-label", `${inst} step ${i+1}`);
          d.addEventListener("click", () => {
            model.tracks[inst][i] = !model.tracks[inst][i];
            renderAll();
          }, {passive:true});
          stepsEl[inst].appendChild(d);
        }
      }
    }

    function renderAscii(){
      const lines = instruments.map(inst => `${inst}: ${toPattern(model.tracks[inst])}`);
      asciiDump.textContent = lines.join("\n");
    }

    function renderModelDump(){
      const dump = {
        bpm: model.bpm,
        tracks: {
          K: toPattern(model.tracks.K),
          S: toPattern(model.tracks.S),
          H: toPattern(model.tracks.H),
        }
      };
      modelDump.textContent = JSON.stringify(dump, null, 2);
    }

    function renderControls(){
      bpmRange.value = String(model.bpm);
      bpmLabel.textContent = String(model.bpm);
      bpmView.textContent = String(model.bpm);

      gainRange.value = String(model.master);
      gainLabel.textContent = model.master.toFixed(2);
    }

    function clearPlayhead(){
      for(const inst of instruments){
        const nodes = stepsEl[inst].children;
        for(let i=0;i<nodes.length;i++){
          nodes[i].classList.remove("playhead");
        }
      }
      stepView.textContent = "-";
    }

    function setPlayhead(step){
      for(const inst of instruments){
        const nodes = stepsEl[inst].children;
        for(let i=0;i<nodes.length;i++){
          nodes[i].classList.toggle("playhead", i === step);
        }
      }
      stepView.textContent = String(step+1);
    }

    function renderAll(){
      renderControls();
      renderGrid();
      renderAscii();
      renderModelDump();
    }

    // -----------------------------
    // Audio ON/OFF (ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°ã®ã‚ªãƒ³/ã‚ªãƒ•)
    //  - ON: AudioContextç”Ÿæˆã—ã¦resume
    //  - OFF: stopã—ã¦AudioContextã‚’closeï¼ˆå®Œå…¨åœæ­¢ï¼‰
    // -----------------------------
    let audioEnabled = false;

    let ctx = null;
    let masterGain = null;
    let limiter = null;

    let isPlaying = false;
    let timerId = null;
    let currentStep = 0;
    let nextTime = 0;

    function updateUIRuntime(){
      // Audio badge + dot
      if(!audioEnabled){
        audioState.textContent = "off";
        dot.className = "dot";
        statusText.textContent = "ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°ã‚’ONã«ã—ã¦ã‹ã‚‰ Play ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚";
      } else if(!ctx){
        audioState.textContent = "locked";
        dot.className = "dot";
        statusText.textContent = "éŸ³å£°ã¯ONã§ã™ã€‚Playã§å†ç”Ÿã—ã¾ã™ï¼ˆã‚¹ãƒãƒ›ã¯æœ€åˆã®æ“ä½œãŒå¿…è¦ï¼‰ã€‚";
      } else {
        audioState.textContent = ctx.state; // running/suspended/closed
        dot.className = "dot " + (ctx.state === "running" ? "ok" : "");
        statusText.textContent = (ctx.state === "running")
          ? "å†ç”Ÿä¸­ã€‚Stopã§åœæ­¢ã—ã¾ã™ã€‚"
          : "éŸ³å£°ã¯ONã§ã™ã€‚Playã§å†ç”Ÿã—ã¾ã™ã€‚";
      }

      audioToggleBtn.textContent = audioEnabled ? "ğŸ”Š ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°: ON" : "ğŸ”‡ ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°: OFF";
      audioToggleBtn.setAttribute("aria-pressed", audioEnabled ? "true" : "false");

      playBtn.disabled = !audioEnabled || isPlaying;
      stopBtn.disabled = !isPlaying;
    }

    function ensureAudio(){
      if(!ctx){
        const AC = window.AudioContext || window.webkitAudioContext;
        ctx = new AC();

        masterGain = ctx.createGain();
        masterGain.gain.value = model.master;

        limiter = ctx.createDynamicsCompressor();
        limiter.threshold.value = -12;
        limiter.knee.value = 18;
        limiter.ratio.value = 6;
        limiter.attack.value = 0.003;
        limiter.release.value = 0.12;

        masterGain.connect(limiter);
        limiter.connect(ctx.destination);
      }
      return ctx;
    }

    async function enableAudio(){
      audioEnabled = true;
      ensureAudio();
      // mobile: must be called from user gesture (button click)
      try { await ctx.resume(); } catch(e) {}
      updateUIRuntime();
    }

    async function disableAudio(){
      stop(); // stop scheduler
      audioEnabled = false;

      // close context for "complete OFF"
      if(ctx){
        try { await ctx.close(); } catch(e) {}
      }
      ctx = null;
      masterGain = null;
      limiter = null;

      updateUIRuntime();
    }

    // -----------------------------
    // Synth
    // -----------------------------
    function playKick(time){
      const o = ctx.createOscillator();
      const g = ctx.createGain();

      o.type = "sine";
      o.frequency.setValueAtTime(140, time);
      o.frequency.exponentialRampToValueAtTime(55, time + 0.10);

      g.gain.setValueAtTime(0.0001, time);
      g.gain.exponentialRampToValueAtTime(0.9, time + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, time + 0.18);

      o.connect(g);
      g.connect(masterGain);

      o.start(time);
      o.stop(time + 0.20);
    }

    function makeNoiseBuffer(durationSec){
      const length = Math.max(1, Math.floor(ctx.sampleRate * durationSec));
      const buffer = ctx.createBuffer(1, length, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<length;i++){
        data[i] = (Math.random()*2 - 1);
      }
      return buffer;
    }

    function playSnare(time){
      const noise = ctx.createBufferSource();
      noise.buffer = makeNoiseBuffer(0.12);

      const noiseFilter = ctx.createBiquadFilter();
      noiseFilter.type = "highpass";
      noiseFilter.frequency.value = 900;

      const noiseGain = ctx.createGain();
      noiseGain.gain.setValueAtTime(0.0001, time);
      noiseGain.gain.exponentialRampToValueAtTime(0.7, time + 0.003);
      noiseGain.gain.exponentialRampToValueAtTime(0.0001, time + 0.12);

      noise.connect(noiseFilter);
      noiseFilter.connect(noiseGain);
      noiseGain.connect(masterGain);

      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "triangle";
      o.frequency.setValueAtTime(180, time);
      g.gain.setValueAtTime(0.0001, time);
      g.gain.exponentialRampToValueAtTime(0.25, time + 0.002);
      g.gain.exponentialRampToValueAtTime(0.0001, time + 0.08);

      o.connect(g);
      g.connect(masterGain);

      noise.start(time);
      noise.stop(time + 0.13);
      o.start(time);
      o.stop(time + 0.10);
    }

    function playHat(time){
      const noise = ctx.createBufferSource();
      noise.buffer = makeNoiseBuffer(0.05);

      const hp = ctx.createBiquadFilter();
      hp.type = "highpass";
      hp.frequency.value = 6000;

      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, time);
      g.gain.exponentialRampToValueAtTime(0.45, time + 0.001);
      g.gain.exponentialRampToValueAtTime(0.0001, time + 0.03);

      noise.connect(hp);
      hp.connect(g);
      g.connect(masterGain);

      noise.start(time);
      noise.stop(time + 0.06);
    }

    function trigger(inst, time){
      if(inst === "K") return playKick(time);
      if(inst === "S") return playSnare(time);
      if(inst === "H") return playHat(time);
    }

    // -----------------------------
    // Scheduler
    // -----------------------------
    function stepDurationSec(){
      return (60 / model.bpm) / 4; // 16th note
    }

    function scheduleAhead(){
      if(!isPlaying) return;
      const lookAhead = 0.12;
      const interval = stepDurationSec();

      while(nextTime < ctx.currentTime + lookAhead){
        for(const inst of instruments){
          if(model.tracks[inst][currentStep]){
            trigger(inst, nextTime);
          }
        }
        const stepToShow = currentStep;
        const showAt = nextTime - ctx.currentTime;
        setTimeout(() => setPlayhead(stepToShow), Math.max(0, showAt*1000));

        nextTime += interval;
        currentStep = (currentStep + 1) % N_STEPS;
      }

      timerId = setTimeout(scheduleAhead, 25);
    }

    async function start(){
      if(!audioEnabled) return;

      ensureAudio();
      try { await ctx.resume(); } catch(e) {}
      if(masterGain) masterGain.gain.value = model.master;

      isPlaying = true;
      currentStep = 0;
      nextTime = ctx.currentTime + 0.03;
      clearPlayhead();

      updateUIRuntime();
      scheduleAhead();
    }

    function stop(){
      isPlaying = false;
      if(timerId) clearTimeout(timerId);
      timerId = null;
      clearPlayhead();
      updateUIRuntime();
    }

    // -----------------------------
    // UI wiring
    // -----------------------------
    bpmRange.addEventListener("input", () => {
      model.bpm = Number(bpmRange.value);
      bpmLabel.textContent = String(model.bpm);
      bpmView.textContent  = String(model.bpm);
      renderModelDump();
    }, {passive:true});

    gainRange.addEventListener("input", () => {
      model.master = Number(gainRange.value);
      gainLabel.textContent = model.master.toFixed(2);
      if(masterGain) masterGain.gain.value = model.master;
    }, {passive:true});

    audioToggleBtn.addEventListener("click", async () => {
      if(audioEnabled) await disableAudio();
      else await enableAudio();
    });

    playBtn.addEventListener("click", () => start(), {passive:true});
    stopBtn.addEventListener("click", () => stop(), {passive:true});

    clearBtn.addEventListener("click", () => {
      for(const inst of instruments) model.tracks[inst] = Array(N_STEPS).fill(false);
      renderAll();
    }, {passive:true});

    demoBtn.addEventListener("click", () => {
      model.bpm = demo.bpm;
      model.master = demo.master;
      model.tracks.K = parsePattern(demo.tracks.K);
      model.tracks.S = parsePattern(demo.tracks.S);
      model.tracks.H = parsePattern(demo.tracks.H);
      renderAll();
    }, {passive:true});

    // initial paint
    renderAll();
    updateUIRuntime();
  </script>
</body>
</html>