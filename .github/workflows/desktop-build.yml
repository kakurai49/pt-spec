name: Desktop Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        working-directory: desktop
        run: npm ci

      - name: Sync web
        working-directory: desktop
        run: npm run sync:web

      - name: Build NSIS installer
        working-directory: desktop
        run: npm run dist:win

      - name: Normalize installer name
        working-directory: desktop
        shell: pwsh
        run: |
          $installer = Get-ChildItem -Path dist -Filter *.exe -File | Select-Object -First 1
          if (-not $installer) { throw "Installer .exe not found in dist" }
          Copy-Item -Path $installer.FullName -Destination (Join-Path $installer.DirectoryName "Setup.exe") -Force

      - name: Build unpacked directory
        working-directory: desktop
        run: npx electron-builder -w --dir

      - name: Verify win-unpacked includes ffmpeg.dll
        working-directory: desktop
        shell: pwsh
        run: |
          if (-not (Test-Path "dist\win-unpacked\ffmpeg.dll")) {
            Write-Host "== dist\win-unpacked listing =="
            Get-ChildItem -Path "dist\win-unpacked" | Format-Table Name,Length
            throw "ffmpeg.dll not found in dist\win-unpacked"
          }
          Write-Host "ffmpeg.dll sha256:"
          Get-FileHash "dist\win-unpacked\ffmpeg.dll" -Algorithm SHA256 | Format-List

      - name: Zip unpacked build
        working-directory: desktop
        run: |
          Compress-Archive -Path dist/win-unpacked/* -DestinationPath dist/win-unpacked.zip

      - name: Upload win-unpacked artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-win-unpacked
          path: desktop/dist/win-unpacked.zip
          retention-days: 7
          if-no-files-found: error

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-win-installer
          path: desktop/dist/Setup.exe
          retention-days: 7
          if-no-files-found: error

  ui-tests-windows:
    runs-on: [self-hosted, windows, win-uia]
    needs: build-windows
    defaults:
      run:
        shell: powershell
    concurrency:
      group: desktop-ui-tests-windows
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download win-unpacked artifact
        uses: actions/download-artifact@v4
        with:
          name: desktop-win-unpacked

      - name: Extract win-unpacked
        run: |
          Remove-Item -Recurse -Force win-unpacked -ErrorAction SilentlyContinue
          Expand-Archive -Path win-unpacked.zip -DestinationPath win-unpacked

      - name: Preflight - verify win-unpacked and ffmpeg.dll
        run: |
          Write-Host "== win-unpacked root listing =="
          Get-ChildItem -Path win-unpacked | Format-Table Name,Length

          if (-not (Test-Path "win-unpacked\ffmpeg.dll")) {
            Write-Host "ffmpeg.dll not found at win-unpacked root. Searching recursively..."
            Get-ChildItem -Path win-unpacked -Filter ffmpeg.dll -Recurse -ErrorAction SilentlyContinue | Format-Table FullName,Length
            throw "ffmpeg.dll not found in win-unpacked"
          }

          Write-Host "ffmpeg.dll sha256:"
          Get-FileHash "win-unpacked\ffmpeg.dll" -Algorithm SHA256 | Format-List

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Preflight - base Python health
        run: |
          Write-Host "== pythonLocation =="
          Write-Host $env:pythonLocation

          Write-Host "== where python =="
          & where.exe python

          Write-Host "== base python =="
          python -V
          python -c "import sys, os; print('exe:', sys.executable); print('prefix:', sys.prefix); print('has os.py:', os.path.exists(os.path.join(sys.prefix,'Lib','os.py')))"

      - name: Create venv (clean) + validate base stdlib
        run: |
          # Host env pollution can break Python prefix resolution
          Remove-Item Env:PYTHONHOME -ErrorAction SilentlyContinue
          Remove-Item Env:PYTHONPATH -ErrorAction SilentlyContinue

          # Ensure clean venv
          Remove-Item -Recurse -Force .venv -ErrorAction SilentlyContinue

          $basePython = Join-Path $env:pythonLocation "python.exe"
          if (-not (Test-Path $basePython)) {
            Write-Host "WARN: base python not found at $basePython. Falling back to 'python' from PATH."
            $basePython = "python"
          }

          # Create venv (no --upgrade-deps: avoid hidden pip execution during creation)
          & $basePython -m venv .venv
          if ($LASTEXITCODE -ne 0) { throw "venv creation failed (exit $LASTEXITCODE)" }

          if (-not (Test-Path ".venv\pyvenv.cfg")) { throw "pyvenv.cfg missing: venv creation failed" }
          Write-Host "== .venv\pyvenv.cfg =="
          Get-Content ".venv\pyvenv.cfg"

          # Validate venv base home stdlib exists
          # NOTE: DO NOT use variable name $home (collides with PowerShell automatic variable $HOME)
          $homeLine = (Select-String -Path ".venv\pyvenv.cfg" -Pattern '^home\s*=' -ErrorAction SilentlyContinue | Select-Object -First 1).Line
          if ($homeLine) {
            $pyHomePath = ($homeLine -replace '^home\s*=\s*','').Trim()
            Write-Host "venv base home: $pyHomePath"
            $osPy = Join-Path $pyHomePath "Lib\os.py"
            if (-not (Test-Path $osPy)) {
              Write-Host "== listing of base home directory =="
              Get-ChildItem -Path $pyHomePath -ErrorAction SilentlyContinue | Format-Table Name,Length
              throw "Base Python stdlib not found: $osPy (toolcache may be broken/cleaned)"
            }
          } else {
            Write-Host "WARN: home line not found in pyvenv.cfg"
          }

          # Confirm venv python can start (ignore PYTHON* env vars with -E)
          .\.venv\Scripts\python.exe -E -c "import sys; print('venv ok:', sys.executable)"
          if ($LASTEXITCODE -ne 0) { throw "venv python failed to start (exit $LASTEXITCODE)" }

      - name: Upgrade pip (venv)
        run: |
          Remove-Item Env:PYTHONHOME -ErrorAction SilentlyContinue
          Remove-Item Env:PYTHONPATH -ErrorAction SilentlyContinue
          .\.venv\Scripts\python.exe -E -m pip install --upgrade pip
          if ($LASTEXITCODE -ne 0) { throw "pip upgrade failed (exit $LASTEXITCODE)" }

      - name: Install UI test dependencies (venv)
        run: |
          Remove-Item Env:PYTHONHOME -ErrorAction SilentlyContinue
          Remove-Item Env:PYTHONPATH -ErrorAction SilentlyContinue
          .\.venv\Scripts\python.exe -E -m pip install -r automation/requirements.txt
          if ($LASTEXITCODE -ne 0) { throw "pip install failed (exit $LASTEXITCODE)" }

      - name: Preflight UI test environment (venv)
        run: |
          Remove-Item Env:PYTHONHOME -ErrorAction SilentlyContinue
          Remove-Item Env:PYTHONPATH -ErrorAction SilentlyContinue

          .\.venv\Scripts\python.exe -E -V
          .\.venv\Scripts\python.exe -E -c "import sys; print(sys.executable); print(sys.version)"
          .\.venv\Scripts\python.exe -E -m pip --version
          .\.venv\Scripts\python.exe -E -m pip list

      - name: Set APP_EXE
        run: |
          $excluded = @("chrome_crashpad_handler.exe", "Uninstall.exe")

          $rootCandidates = Get-ChildItem -Path win-unpacked -Filter *.exe -File |
            Where-Object { $excluded -notcontains $_.Name }

          $exeCandidates = if ($rootCandidates) {
            $rootCandidates
          } else {
            Get-ChildItem -Path win-unpacked -Filter *.exe -File -Recurse |
              Where-Object { $excluded -notcontains $_.Name }
          }

          if (-not $exeCandidates) { throw "APP_EXE not found in win-unpacked" }

          # deterministic: length desc then fullname asc
          $exe = $exeCandidates | Sort-Object @{Expression='Length';Descending=$true}, @{Expression='FullName';Descending=$false} | Select-Object -First 1

          Write-Host "Selected APP_EXE: $($exe.FullName)"
          "APP_EXE=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Run UI tests
        run: |
          Remove-Item Env:PYTHONHOME -ErrorAction SilentlyContinue
          Remove-Item Env:PYTHONPATH -ErrorAction SilentlyContinue

          New-Item -ItemType Directory -Force -Path "automation" | Out-Null

          # Use venv python; ignore PYTHON* env vars with -E; capture all streams
          .\.venv\Scripts\python.exe -E -X faulthandler -m pytest -q *>&1 | Tee-Object -FilePath automation/pytest.log
          exit $LASTEXITCODE

      - name: Collect Windows EventLog on failure
        if: failure()
        run: |
          $eventLogPath = "automation/artifacts/windows-eventlog.txt"
          New-Item -ItemType Directory -Path (Split-Path $eventLogPath) -Force | Out-Null
          $startTime = (Get-Date).AddMinutes(-10)

          Get-WinEvent -FilterHashtable @{ LogName = "Application"; StartTime = $startTime } -ErrorAction SilentlyContinue |
            Where-Object { $_.ProviderName -in "Application Error", "Windows Error Reporting" } |
            Select-Object TimeCreated, Id, LevelDisplayName, ProviderName, Message |
            Format-List | Out-File -FilePath $eventLogPath -Encoding utf8

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          if (-not $env:APP_EXE) { throw "APP_EXE is not set" }
          ./automation/collect_windows_diagnostics.ps1 -AppExe "$env:APP_EXE"

      - name: Upload UI test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: desktop-ui-test-artifacts
          path: |
            automation/pytest.log
            automation/artifacts
            automation/screenshots
            automation/test-results
          if-no-files-found: warn
          retention-days: 7
