name: Desktop Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        working-directory: desktop
        run: npm ci

      - name: Sync web
        working-directory: desktop
        run: npm run sync:web

      - name: Build NSIS installer
        working-directory: desktop
        run: npm run dist:win

      - name: Normalize installer name
        working-directory: desktop
        shell: pwsh
        run: |
          $installer = Get-ChildItem -Path dist -Filter *.exe -File | Select-Object -First 1
          if (-not $installer) { throw "Installer .exe not found in dist" }
          Copy-Item -Path $installer.FullName -Destination (Join-Path $installer.DirectoryName "Setup.exe") -Force

      - name: Build unpacked directory
        working-directory: desktop
        run: npx electron-builder -w --dir

      - name: Zip unpacked build
        working-directory: desktop
        run: |
          Compress-Archive -Path dist/win-unpacked/* -DestinationPath dist/win-unpacked.zip

      - name: Upload win-unpacked artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-win-unpacked
          path: desktop/dist/win-unpacked.zip
          retention-days: 7
          if-no-files-found: error

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-win-installer
          path: desktop/dist/Setup.exe
          retention-days: 7
          if-no-files-found: error

  ui-tests-windows:
    runs-on: [self-hosted, windows, win-uia]
    needs: build-windows
    concurrency:
      group: desktop-ui-tests-windows
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download win-unpacked artifact
        uses: actions/download-artifact@v4
        with:
          name: desktop-win-unpacked

      - name: Extract win-unpacked
        run: |
          Expand-Archive -Path win-unpacked.zip -DestinationPath win-unpacked

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Verify Python SSL and pip
        run: |
          python -c "import ssl; print(ssl.OPENSSL_VERSION)"
          python -m ensurepip --upgrade

      - name: Install UI test dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r automation/requirements.txt

      - name: Set APP_EXE
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path win-unpacked -Filter *.exe -Recurse | Select-Object -First 1
          if (-not $exe) { throw "APP_EXE not found in win-unpacked" }
          "APP_EXE=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Run UI tests
        shell: pwsh
        run: |
          pytest -q 2>&1 | Tee-Object -FilePath automation/pytest.log

      - name: Upload UI test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: desktop-ui-test-artifacts
          path: |
            automation/pytest.log
            automation/screenshots
            automation/test-results
          if-no-files-found: warn
          retention-days: 7
