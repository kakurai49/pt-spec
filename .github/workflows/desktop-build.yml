name: Desktop Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        working-directory: desktop
        run: npm ci

      - name: Sync web
        working-directory: desktop
        run: npm run sync:web

      - name: Build NSIS installer
        working-directory: desktop
        run: npm run dist:win

      - name: Normalize installer name
        working-directory: desktop
        shell: pwsh
        run: |
          $installer = Get-ChildItem -Path dist -Filter *.exe -File | Select-Object -First 1
          if (-not $installer) { throw "Installer .exe not found in dist" }
          Copy-Item -Path $installer.FullName -Destination (Join-Path $installer.DirectoryName "Setup.exe") -Force

      - name: Build unpacked directory
        working-directory: desktop
        run: npx electron-builder -w --dir

      - name: Zip unpacked build
        working-directory: desktop
        run: |
          Compress-Archive -Path dist/win-unpacked/* -DestinationPath dist/win-unpacked.zip

      - name: Upload win-unpacked artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-win-unpacked
          path: desktop/dist/win-unpacked.zip
          retention-days: 7
          if-no-files-found: error

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-win-installer
          path: desktop/dist/Setup.exe
          retention-days: 7
          if-no-files-found: error

      # --- ここからが「ゼロベース安定化」の追加 ---
      # self-hosted で setup-python を使わず、GitHub-hosted 側で “正常な Python ランタイム” を作って渡す
      - name: Setup Python for UI tests (hosted runner)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.9'
          architecture: 'x64'

      - name: Package Python runtime as artifact (portable)
        shell: pwsh
        run: |
          python -c "import sys; print('python:', sys.executable); print('prefix:', sys.prefix); print(sys.version)"
          $prefix = python -c "import sys; print(sys.prefix)"

          # 標準ライブラリがあることをここで保証（self-hosted 側の壊れた toolcache を回避するため）
          if (-not (Test-Path "$prefix\Lib\os.py")) {
            Write-Host "== python prefix listing =="
            Get-ChildItem -Path $prefix | Format-Table Name,Length
            throw "Hosted python prefix is missing stdlib (Lib\\os.py). Cannot create portable runtime."
          }

          Remove-Item -Force python-runtime.zip -ErrorAction SilentlyContinue
          Compress-Archive -Path "$prefix\*" -DestinationPath "python-runtime.zip"

      - name: Build wheels for UI tests (optional but recommended)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          Remove-Item -Recurse -Force ui-wheels -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force ui-wheels | Out-Null

          # automation/requirements.txt を “wheel として固定” して self-hosted 側でのブレを無くす
          python -m pip download -r automation/requirements.txt -d ui-wheels

      - name: Upload Python runtime artifact
        uses: actions/upload-artifact@v4
        with:
          name: ui-python-runtime-win-x64
          path: python-runtime.zip
          retention-days: 7
          if-no-files-found: error

      - name: Upload Python wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: ui-python-wheels-win-x64
          path: ui-wheels
          retention-days: 7
          if-no-files-found: error

  ui-tests-windows:
    runs-on: [self-hosted, windows, win-uia]
    needs: build-windows
    defaults:
      run:
        shell: powershell
    concurrency:
      group: desktop-ui-tests-windows
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download win-unpacked artifact
        uses: actions/download-artifact@v4
        with:
          name: desktop-win-unpacked
          path: artifacts/win-unpacked

      - name: Download Python runtime artifact
        uses: actions/download-artifact@v4
        with:
          name: ui-python-runtime-win-x64
          path: artifacts/python-runtime

      - name: Download Python wheels artifact
        uses: actions/download-artifact@v4
        with:
          name: ui-python-wheels-win-x64
          path: artifacts/python-wheels

      - name: Extract win-unpacked
        run: |
          Remove-Item -Recurse -Force win-unpacked -ErrorAction SilentlyContinue
          Expand-Archive -Path artifacts/win-unpacked/win-unpacked.zip -DestinationPath win-unpacked

      - name: Extract Python runtime
        run: |
          Remove-Item -Recurse -Force python-dist -ErrorAction SilentlyContinue
          Expand-Archive -Path artifacts/python-runtime/python-runtime.zip -DestinationPath python-dist

          if (-not (Test-Path "python-dist\python.exe")) {
            Write-Host "== python-dist listing =="
            Get-ChildItem -Path python-dist | Format-Table Name,Length
            throw "python-dist\\python.exe not found after extraction"
          }

          if (-not (Test-Path "python-dist\Lib\os.py")) {
            Write-Host "== python-dist listing =="
            Get-ChildItem -Path python-dist | Format-Table Name,Length
            throw "python-dist is missing stdlib (Lib\\os.py). The runtime artifact is broken."
          }

      - name: Create venv using bundled Python (NO setup-python on self-hosted)
        run: |
          Remove-Item -Recurse -Force .venv -ErrorAction SilentlyContinue

          # ここで必ず “bundle した python” を使う（self-hosted の壊れた toolcache を踏まない）
          .\python-dist\python.exe -m venv .venv
          if ($LASTEXITCODE -ne 0) { throw "venv creation failed (exit $LASTEXITCODE)" }

          .\.venv\Scripts\python.exe -m pip install --upgrade pip
          if ($LASTEXITCODE -ne 0) { throw "pip upgrade failed (exit $LASTEXITCODE)" }

      - name: Install UI test dependencies (prefer wheels, fallback online)
        run: |
          $ErrorActionPreference = "Stop"
          try {
            .\.venv\Scripts\python.exe -m pip install --no-index --find-links artifacts/python-wheels -r automation/requirements.txt
          } catch {
            Write-Host "Offline wheel install failed; falling back to online pip install..."
            .\.venv\Scripts\python.exe -m pip install -r automation/requirements.txt
          }

      - name: Preflight UI test environment
        run: |
          .\.venv\Scripts\python.exe -V
          .\.venv\Scripts\python.exe -c "import sys; print(sys.executable); print(sys.version)"
          .\.venv\Scripts\python.exe -m pip list

          Write-Host "== win-unpacked root listing =="
          Get-ChildItem win-unpacked | Format-Table Name,Length

          if (-not (Test-Path win-unpacked\ffmpeg.dll)) {
            Write-Host "ffmpeg.dll not found at root, searching recursively..."
            Get-ChildItem -Path win-unpacked -Filter ffmpeg.dll -Recurse | Format-Table FullName,Length
            throw "ffmpeg.dll not found in win-unpacked"
          }

          Get-FileHash win-unpacked\ffmpeg.dll -Algorithm SHA256

      - name: Set APP_EXE
        run: |
          $excluded = @("chrome_crashpad_handler.exe", "Uninstall.exe")

          $rootCandidates = Get-ChildItem -Path win-unpacked -Filter *.exe -File |
            Where-Object { $excluded -notcontains $_.Name }

          $exeCandidates = if ($rootCandidates) {
            $rootCandidates
          } else {
            Get-ChildItem -Path win-unpacked -Filter *.exe -File -Recurse |
              Where-Object { $excluded -notcontains $_.Name }
          }

          if (-not $exeCandidates) { throw "APP_EXE not found in win-unpacked" }

          # deterministic: size desc, fullname asc
          $exe = $exeCandidates |
            Sort-Object @{Expression='Length';Descending=$true}, @{Expression='FullName';Descending=$false} |
            Select-Object -First 1

          Write-Host "Selected APP_EXE: $($exe.FullName)"
          "APP_EXE=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Run UI tests
        run: |
          New-Item -ItemType Directory -Force -Path "automation" | Out-Null

          # python.exe 経由に固定（pytest.exe stub/ PATH 汚染を踏まない）
          .\.venv\Scripts\python.exe -X faulthandler -m pytest -q *>&1 | Tee-Object -FilePath automation/pytest.log
          exit $LASTEXITCODE

      - name: Collect Windows EventLog on failure
        if: failure()
        run: |
          $eventLogPath = "automation/artifacts/windows-eventlog.txt"
          New-Item -ItemType Directory -Path (Split-Path $eventLogPath) -Force | Out-Null
          $startTime = (Get-Date).AddMinutes(-10)

          Get-WinEvent -FilterHashtable @{ LogName = "Application"; StartTime = $startTime } -ErrorAction SilentlyContinue |
            Where-Object { $_.ProviderName -in "Application Error", "Windows Error Reporting" } |
            Select-Object TimeCreated, Id, LevelDisplayName, ProviderName, Message |
            Format-List | Out-File -FilePath $eventLogPath -Encoding utf8

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          if (-not $env:APP_EXE) { throw "APP_EXE is not set" }
          ./automation/collect_windows_diagnostics.ps1 -AppExe "$env:APP_EXE"

      - name: Upload UI test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: desktop-ui-test-artifacts
          path: |
            automation/pytest.log
            automation/artifacts
            automation/screenshots
            automation/test-results
          if-no-files-found: warn
          retention-days: 7
