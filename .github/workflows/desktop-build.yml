name: Desktop Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        working-directory: desktop
        run: npm ci

      - name: Sync web
        working-directory: desktop
        run: npm run sync:web

      - name: Build NSIS installer
        working-directory: desktop
        run: npm run dist:win

      - name: Normalize installer name
        working-directory: desktop
        shell: pwsh
        run: |
          $installer = Get-ChildItem -Path dist -Filter *.exe -File | Select-Object -First 1
          if (-not $installer) { throw "Installer .exe not found in dist" }
          Copy-Item -Path $installer.FullName -Destination (Join-Path $installer.DirectoryName "Setup.exe") -Force

      - name: Build unpacked directory
        working-directory: desktop
        run: npx electron-builder -w --dir

      - name: Zip unpacked build
        working-directory: desktop
        run: |
          Compress-Archive -Path dist/win-unpacked/* -DestinationPath dist/win-unpacked.zip

      - name: Upload win-unpacked artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-win-unpacked
          path: desktop/dist/win-unpacked.zip
          retention-days: 7
          if-no-files-found: error

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-win-installer
          path: desktop/dist/Setup.exe
          retention-days: 7
          if-no-files-found: error

  ui-tests-windows:
    runs-on: [self-hosted, windows, win-uia]
    needs: build-windows
    defaults:
      run:
        shell: powershell
    concurrency:
      group: desktop-ui-tests-windows
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download win-unpacked artifact
        uses: actions/download-artifact@v4
        with:
          name: desktop-win-unpacked

      - name: Extract win-unpacked
        run: |
          Expand-Archive -Path win-unpacked.zip -DestinationPath win-unpacked

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create venv
        run: |
          python -m venv .venv
          .\.venv\Scripts\python -m pip install --upgrade pip

      - name: Verify venv Python SSL and pip
        run: |
          .\.venv\Scripts\python -c "import ssl; print(ssl.OPENSSL_VERSION)"
          .\.venv\Scripts\python -m ensurepip --upgrade

      - name: Install UI test dependencies
        run: |
          .\.venv\Scripts\python -m pip install -r automation/requirements.txt

      - name: Preflight UI test environment
        run: |
          .\.venv\Scripts\python -V
          .\.venv\Scripts\python -c "import sys; print(sys.executable); print(sys.version)"
          .\.venv\Scripts\python -m pip list
          Get-ChildItem win-unpacked | Format-Table Name,Length
          if (-not (Test-Path win-unpacked\ffmpeg.dll)) {
            Get-ChildItem -Path win-unpacked -Filter ffmpeg.dll -Recurse | Format-Table FullName,Length
            throw "ffmpeg.dll not found in win-unpacked"
          }
          Get-FileHash win-unpacked\ffmpeg.dll -Algorithm SHA256

      - name: Set APP_EXE
        run: |
          $excluded = @("chrome_crashpad_handler.exe", "Uninstall.exe")
          $rootCandidates = Get-ChildItem -Path win-unpacked -Filter *.exe -File |
            Where-Object { $excluded -notcontains $_.Name }
          $exeCandidates = if ($rootCandidates) {
            $rootCandidates
          } else {
            Get-ChildItem -Path win-unpacked -Filter *.exe -File -Recurse |
              Where-Object { $excluded -notcontains $_.Name }
          }
          if (-not $exeCandidates) { throw "APP_EXE not found in win-unpacked" }
          $exe = $exeCandidates | Sort-Object Length, FullName | Select-Object -Last 1
          "APP_EXE=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Run UI tests
        run: |
          .\.venv\Scripts\python -X faulthandler -m pytest -q 2>&1 | Tee-Object -FilePath automation/pytest.log
          exit $LASTEXITCODE

      - name: Collect Windows EventLog on failure
        if: failure()
        run: |
          $eventLogPath = "automation/artifacts/windows-eventlog.txt"
          New-Item -ItemType Directory -Path (Split-Path $eventLogPath) -Force | Out-Null
          $startTime = (Get-Date).AddMinutes(-10)
          Get-WinEvent -FilterHashtable @{ LogName = "Application"; StartTime = $startTime } -ErrorAction SilentlyContinue |
            Where-Object { $_.ProviderName -in "Application Error", "Windows Error Reporting" } |
            Select-Object TimeCreated, Id, LevelDisplayName, ProviderName, Message |
            Format-List | Out-File -FilePath $eventLogPath -Encoding utf8

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          if (-not $env:APP_EXE) { throw "APP_EXE is not set" }
          ./automation/collect_windows_diagnostics.ps1 -AppExe "$env:APP_EXE"

      - name: Upload UI test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: desktop-ui-test-artifacts
          path: |
            automation/pytest.log
            automation/artifacts
            automation/screenshots
            automation/test-results
          if-no-files-found: warn
          retention-days: 7
